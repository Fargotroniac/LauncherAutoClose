name: Sestavení pro testování
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Work Branch
        uses: actions/checkout@v4
        with:
          ref: work

      - name: Assemble Script
        shell: pwsh
        run: |
          function Get-PSHash($data) {
              if ($null -eq $data) { return "" }
              $lines = foreach ($prop in $data.psobject.Properties) {
                  "    `"$($prop.Name)`" = `"$($prop.Value)`""
              }
              return $lines -join "`r`n"
          }

          function Get-PSObject($data) {
              if ($null -eq $data) { return " @{ Companies = @(); Processes = @() }" }
              $companies = ($data.Companies | ForEach-Object { "`"$_`"" }) -join ", "
              $processes = ($data.Processes | ForEach-Object { "`"$_`"" }) -join ", "
              return "[PSCustomObject]@{ Companies = @($companies); Processes = @($processes) }"
          }

          $ubiJson = Get-Content "data/ubisoft.json" -Raw | ConvertFrom-Json
          $blizzJson = Get-Content "data/blizzard.json" -Raw | ConvertFrom-Json

          $ubiGames = Get-PSHash $ubiJson.Games
          $ubiLauncher = Get-PSObject $ubiJson.Launcher
          
          $blizzGames = Get-PSHash $blizzJson.Games
          $blizzLauncher = Get-PSObject $blizzJson.Launcher
          
          $version = Get-Date -Format "yyyy.MM.dd.HHmm"
          $template = Get-Content "src/template.ps1" -Raw

          $content = $template.Replace("#BUILD_VERSION#", $version)
          $content = $content.Replace("#INSERT_UBI_GAMES#", $ubiGames)
          $content = $content.Replace("#INSERT_UBI_LAUNCHER#", $ubiLauncher)
          $content = $content.Replace("#INSERT_BLIZZ_GAMES#", $blizzGames)
          $content = $content.Replace("#INSERT_BLIZZ_LAUNCHER#", $blizzLauncher)
          
          $content | Set-Content "..\LauncherAutoClose_generated.ps1" -Encoding utf8

      - name: Sestavení pro testování
        shell: pwsh
        run: |
          git config --global user.name "Fargotroniac"
          git config --global user.email "Fargotroniac@icloud.com"
          
          git fetch origin beta
          git checkout beta -f || git checkout -b beta
          
          Move-Item "..\LauncherAutoClose_generated.ps1" "LauncherAutoClose.ps1" -Force
          
          git add LauncherAutoClose.ps1
          git commit -m "Beta Build - $(Get-Date -Format 'yyyy-MM-dd HH:mm')" || exit 0
          git push origin beta -f