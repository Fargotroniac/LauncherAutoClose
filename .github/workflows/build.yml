name: LAC Build Engine
on:
  push:
    branches: [ work ]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process JSON Data
        shell: pwsh
        run: |
          try {
              # 1. Načtení Launcherů
              $launchers = Get-Content "data/launchers.json" -Raw | ConvertFrom-Json -ErrorAction Stop
              $lLines = @()
              foreach ($l in $launchers) {
                  $pattern = $l.Companies -join "|"
                  foreach ($p in $l.Processes) { 
                      $lLines += "    `"$p`" = `"$pattern`"" 
                  }
              }
              
              # 2. Načtení Ubisoft her
              $ubi = Get-Content "data/ubisoft.json" -Raw | ConvertFrom-Json -ErrorAction Stop
              $ubiLines = foreach ($prop in $ubi.psobject.Properties) {
                  "    `"$($prop.Name)`" = `"$($prop.Value)`""
              }

              # 3. Načtení Blizzard her
              $blizz = Get-Content "data/blizzard.json" -Raw | ConvertFrom-Json -ErrorAction Stop
              $blizzLines = foreach ($prop in $blizz.psobject.Properties) {
                  "    `"$($prop.Name)`" = `"$($prop.Value)`""
              }

              # 4. Sestavení výsledného skriptu
              if (-not (Test-Path "src/template.ps1")) { throw "Sablona src/template.ps1 nebyla nalezena!" }
              $template = Get-Content "src/template.ps1" -Raw -ErrorAction Stop
              $template = $template.Replace("#INSERT_LAUNCHERS#", ($lLines -join "`r`n"))
              $template = $template.Replace("#INSERT_UBI_GAMES#", ($ubiLines -join "`r`n"))
              $template = $template.Replace("#INSERT_BLIZZ_GAMES#", ($blizzLines -join "`r`n"))
              
              # Verze a uložení
              $v = Get-Date -Format "yyyy.MM.dd.HHmm"
              $template = $template -replace '0.0.0.0', $v
              $template | Set-Content "LauncherAutoClose.ps1" -Encoding utf8
              
              Write-Host "Build uspesne dokoncen pro verzi $v"
          }
          catch {
              Write-Error "Chyba pri zpracovani: $($_.Exception.Message)"
              exit 1
          }

      - name: Deploy to Main
        shell: pwsh
        run: |
          git config --global user.name "Fargotroniac"
          git config --global user.email "Fargotroniac@icloud.com"
          
          # 1. Uložíme si vygenerovaný skript do dočasné paměti
          if (-not (Test-Path "LauncherAutoClose.ps1")) { throw "Vystupni soubor nebyl vytvoren!" }
          $generatedScript = Get-Content "LauncherAutoClose.ps1" -Raw
          
          # 2. Přepneme se do main
          git fetch origin main
          git checkout main -f
          
          # 3. Vložíme tam ten nový skript
          $generatedScript | Set-Content "LauncherAutoClose.ps1" -Encoding utf8
          
          # 4. Odešleme změny
          git add LauncherAutoClose.ps1
          git commit -m "Automated build $(Get-Date -Format 'yyyy-MM-dd HH:mm')"
          git push origin main -f
