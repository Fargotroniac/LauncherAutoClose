name: Build and Deploy to Beta
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Work Branch
        uses: actions/checkout@v4
        with:
          ref: work

      - name: Assemble Script
        shell: pwsh
        run: |
          function Get-PSHash($path) {
              if (!(Test-Path $path)) { return "" }
              $json = Get-Content $path -Raw | ConvertFrom-Json
              $lines = foreach ($prop in $json.psobject.Properties) {
                  "    `"$($prop.Name)`" = `"$($prop.Value)`""
              }
              return $lines -join "`r`n"
          }

          $ubi = Get-PSHash "data/ubisoft.json"
          $blizz = Get-PSHash "data/blizzard.json"
          $version = Get-Date -Format "yyyy.MM.dd.HHmm"
          
          $content = Get-Content "src/template.ps1" -Raw
          $content = $content.Replace("#INSERT_UBI_GAMES#", $ubi)
          $content = $content.Replace("#INSERT_BLIZZ_GAMES#", $blizz)
          $content = $content.Replace("#BUILD_VERSION#", $version)
          
          # Uložíme si skript do dočasné složky mimo git strukturu
          $content | Set-Content "..\LauncherAutoClose_generated.ps1" -Encoding utf8

      - name: Deploy to Beta Branch
        shell: pwsh
        run: |
          git config --global user.name "Fargotroniac"
          git config --global user.email "Fargotroniac@icloud.com"
          
          # Přepnutí na betu
          git fetch origin beta
          git checkout beta -f || git checkout -b beta
          
          # Přesuneme vygenerovaný soubor z dočasného umístění sem
          Move-Item "..\LauncherAutoClose_generated.ps1" "LauncherAutoClose.ps1" -Force
          
          # Teď už Git uvidí změnu
          git add LauncherAutoClose.ps1
          git commit -m "Beta Build - $(Get-Date -Format 'yyyy-MM-dd HH:mm')" || exit 0
          git push origin beta -f
