name: Sestavení pro testování
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Work Branch
        uses: actions/checkout@v4
        with:
          ref: work

      - name: Assemble Script
        shell: pwsh
        run: |
          # Funkce pro vnitřek hashtabulky (Klíč = Hodnota)
          function Get-PSHash($data) {
              if ($null -eq $data) { return "" }
              $lines = foreach ($prop in $data.psobject.Properties) {
                  "    `"$($prop.Name)`" = `"$($prop.Value)`""
              }
              return $lines -join "`r`n"
          }

          # Speciální funkce pro vnitřek hashtabulky s poli (Companies/Processes)
          function Get-PSLauncherHash($data) {
              if ($null -eq $data) { return "    Companies = @(); Processes = @()" }
              $comps = ($data.Companies | ForEach-Object { "`"$_`"" }) -join ", "
              $procs = ($data.Processes | ForEach-Object { "`"$_`"" }) -join ", "
              return "    Companies = @($comps);`r`n    Processes = @($procs)"
          }

          $ubiJson = Get-Content "data/ubisoft.json" -Raw | ConvertFrom-Json
          $blizzJson = Get-Content "data/blizzard.json" -Raw | ConvertFrom-Json

          $template = Get-Content "src/template.ps1" -Raw
          $version = Get-Date -Format "yyyy.MM.dd.HHmm"

          # Nahrazení značek - všimni si nových názvů funkcí
          $content = $template.Replace("#BUILD_VERSION#", $version)
          $content = $content.Replace("#INSERT_UBI_GAMES#", (Get-PSHash $ubiJson.Games))
          $content = $content.Replace("#INSERT_UBI_LAUNCHER#", (Get-PSLauncherHash $ubiJson.Launcher))
          $content = $content.Replace("#INSERT_BLIZZ_GAMES#", (Get-PSHash $blizzJson.Games))
          $content = $content.Replace("#INSERT_BLIZZ_LAUNCHER#", (Get-PSLauncherHash $blizzJson.Launcher))
          
          $content | Set-Content "..\LauncherAutoClose_generated.ps1" -Encoding utf8

      - name: Sestavení pro testování
        shell: pwsh
        run: |
          git config --global user.name "Fargotroniac"
          git config --global user.email "Fargotroniac@icloud.com"
          
          git fetch origin beta
          git checkout beta -f || git checkout -b beta
          
          Move-Item "..\LauncherAutoClose_generated.ps1" "LauncherAutoClose.ps1" -Force
          
          git add LauncherAutoClose.ps1
          git commit -m "Beta Build - $(Get-Date -Format 'yyyy-MM-dd HH:mm')" || exit 0
          git push origin beta -f