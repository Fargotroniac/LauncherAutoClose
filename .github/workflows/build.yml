name: LAC Build Engine
on:
  push:
    branches: [ work ]

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write # Důležité: Povoluje robotovi zapisovat do main
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process JSON Data
        shell: pwsh
        run: |
          try {
              # Načtení Her
              $games = Get-Content "data/games.json" -Raw | ConvertFrom-Json -ErrorAction Stop
              $gLines = foreach ($prop in $games.psobject.Properties) {
                  "    `"$($prop.Name)`" = `"$($prop.Value)`""
              }

              # Načtení Launcherů
              $launchers = Get-Content "data/launchers.json" -Raw | ConvertFrom-Json -ErrorAction Stop
              $lLines = foreach ($l in $launchers) {
                  $pattern = $l.Companies -join "|"
                  foreach ($p in $l.Processes) { "    `"$p`" = `"$pattern`"" }
              }

              # Sestavení
              $template = Get-Content "src/template.ps1" -Raw -ErrorAction Stop
              $template = $template.Replace("#INSERT_LAUNCHERS#", ($lLines -join "`r`n"))
              $template = $template.Replace("#INSERT_GAMES#", ($gLines -join "`r`n"))
              
              $v = Get-Date -Format "yyyy.MM.dd.HHmm"
              $template = $template -replace '0.0.0.0', $v
              
              $template | Set-Content "LauncherAutoClose.ps1" -Encoding utf8
              Write-Host "Sestaveni probehlo uspesne pro verzi $v"
          }
          catch {
              Write-Error "CHYBA: Pravdepodobne mas chybu v JSONu (chybejici uvozovky nebo carka navic)."
              Write-Error $_.Exception.Message
              exit 1
          }

      - name: Deploy to Main
        shell: pwsh
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          # 1. Uložíme si vygenerovaný skript do dočasné paměti
          $generatedScript = Get-Content "LauncherAutoClose.ps1" -Raw
          
          # 2. Přepneme se do main (a vynutíme si to)
          git fetch origin main
          git checkout main -f
          
          # 3. Vložíme tam ten nový skript (přepíšeme starý)
          $generatedScript | Set-Content "LauncherAutoClose.ps1" -Encoding utf8
          
          # 4. Odešleme změny
          git add LauncherAutoClose.ps1
          git commit -m "Automated build $(Get-Date -Format 'yyyy-MM-dd HH:mm')"
          git push origin main -f
